---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import Hr from "@/components/Hr.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";
import Parser from "rss-parser";
import { SOCIALS } from "@/constants";

function getCover(ep: any) {
  return (
    ep.itunes?.image ??
    ep.itunes?.["image:href"] ??
    ep["itunes:image"]?.href ??
    coverFallback
  );
}

function getXiaoyuzhouLink(ep: any) {
  return ep.link;
}

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
const parser = new Parser();
const feed = await parser.parseURL("https://feed.xyzfm.space/6vnv3ae7g34t");
const episodes = feed.items;
const coverFallback = feed.image?.url ?? "/logo.png";
const challenges = [
  // ğŸ‘‰ åç»­ç»§ç»­å¾€ä¸‹åŠ å³å¯
  "æœ¬æœŸæŒ‘æˆ˜ï¼šç»™åˆ«äººåšä¸€é“èœ",
  "æœ¬æœŸæŒ‘æˆ˜ï¼šå¥åº·ä½œæ¯ï¼›çœ‹ç”µå½±çº¢è¾£æ¤’ï¼Œè„±å£ç§€ä¸“åœºã€Šä½ è°å•Šã€‹",
  "æœ¬æœŸæŒ‘æˆ˜ï¼šç¡è§‰å‰ï¼Œèµ·åºŠåä¸ç©æ‰‹æœº",
];
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index">
    <section id="hero" class="pt-8 pb-6">
      <h1 class="my-4 inline-block text-4xl font-bold sm:my-8 sm:text-5xl">
        è½»æ¾æ„‰å¿«
      </h1>
      <p class="mb-4 text-gray-600">
        @ohaaayooo, @frank
        å’Œå¥½æœ‹å‹ä»¬çš„é—²èŠæ’­å®¢ã€‚åœ¨è¿™é‡Œä½ å¯ä»¥æ‰¾åˆ°ï¼Œå¾€æœŸèŠ‚ç›®ï¼Œç›¸å…³é“¾æ¥ï¼Œè½»æ¾æ­Œå•ï¼Œä¸æ„‰å¿«æ—¥å†ï¼Œå®‰åˆ©çš„é¤å…å’Œä¸€äº›å…¶ä»–å’Œæƒ³è±¡æœ‰å…³çš„ä¸œè¥¿ã€‚(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§
      </p>
      <!-- æ’­å®¢å¹³å°é“¾æ¥ -->
      <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
        <a
          href="https://feed.xyzfm.space/6vnv3ae7g34t"
          target="_blank"
          class="inline-flex items-center gap-2 rounded-md border border-accent px-3 py-1.5 text-accent transition hover:bg-accent hover:text-white"
          aria-label="RSS Feed"
          title="RSS è®¢é˜…"
        >
          <IconRss class="h-4 w-4" />
          RSS è®¢é˜…
        </a>
      </div>

      {
        // only display if at least one social link is enabled
        SOCIALS.length > 0 && (
          <div class="mt-4 flex flex-col sm:flex-row sm:items-center">
            <div class="mr-2 mb-1 whitespace-nowrap sm:mb-0">Social Links:</div>
            <Socials />
          </div>
        )
      }
    </section>

    <Hr />
    <section id="podcast" class="pt-12 pb-6">
      <h2 class="mb-4 text-center text-2xl font-semibold tracking-wide">
        ğŸ§ Episodes
      </h2>
      <div class="space-y-6">
        {
          episodes.map((ep: any, index: number) => (
            <article class="flex flex-col rounded-lg border border-gray-200 shadow-sm transition hover:shadow sm:flex-row">
              <img
                src={getCover(ep)}
                alt={ep.title}
                class="m-4 w-full flex-shrink-0 self-center rounded-md object-cover sm:h-36 sm:w-36"
              />
              <div class="flex-1 px-4 py-3">
                <h3 class="mb-1 text-lg font-semibold">{ep.title}</h3>
                <p class="mb-2 text-xs text-gray-400">{ep.pubDate}</p>
                <audio controls class="mb-2 w-full">
                  <source src={ep.enclosure?.url} type="audio/mpeg" />
                </audio>
                {challenges[index] && (
                  <p class="mt-2 text-sm font-medium text-gray-600">
                    {challenges[index]}
                  </p>
                )}
              </div>
            </article>
          ))
        }
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
